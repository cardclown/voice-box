<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è¾“å…¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .record-btn {
            background: #4CAF50;
            color: white;
        }
        .record-btn.recording {
            background: #f44336;
        }
        .stop-btn {
            background: #2196F3;
            color: white;
        }
        .permission-btn {
            background: #FF9800;
            color: white;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 5px;
            min-height: 50px;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .info {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ è¯­éŸ³è¾“å…¥åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. éº¦å…‹é£æƒé™æµ‹è¯•</h3>
            <button class="permission-btn" onclick="testPermission()">è¯·æ±‚éº¦å…‹é£æƒé™</button>
            <div class="status" id="permission-status">çŠ¶æ€: æœªæ£€æŸ¥</div>
        </div>

        <div class="test-section">
            <h3>2. å½•éŸ³åŠŸèƒ½æµ‹è¯•</h3>
            <button class="record-btn" id="record-btn" onclick="toggleRecording()">å¼€å§‹å½•éŸ³</button>
            <div class="status" id="recording-status">çŠ¶æ€: æœªå¼€å§‹</div>
            <div class="info">ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³,å†æ¬¡ç‚¹å‡»åœæ­¢</div>
        </div>

        <div class="test-section">
            <h3>3. è¯­éŸ³è¯†åˆ«æµ‹è¯•</h3>
            <button class="stop-btn" onclick="testRecognition()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <div class="status" id="recognition-status">çŠ¶æ€: æœªå¼€å§‹</div>
            <div class="result" id="recognition-result">è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            <div class="info">
                æµ‹è¯•å‚æ•°:<br>
                - userId: 1<br>
                - sessionId: 1<br>
                - language: zh-CN<br>
                - API: http://localhost:10088/api/voice/upload
            </div>
        </div>

        <div class="test-section">
            <h3>4. APIè¿æ¥æµ‹è¯•</h3>
            <button class="stop-btn" onclick="testAPI()">æµ‹è¯•åç«¯API</button>
            <div class="status" id="api-status">çŠ¶æ€: æœªæµ‹è¯•</div>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioStream = null;

        async function testPermission() {
            const statusEl = document.getElementById('permission-status');
            try {
                statusEl.textContent = 'çŠ¶æ€: è¯·æ±‚æƒé™ä¸­...';
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                statusEl.textContent = 'çŠ¶æ€: âœ… æƒé™å·²æˆäºˆ';
                statusEl.style.background = '#e8f5e9';
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                statusEl.textContent = 'çŠ¶æ€: âŒ æƒé™è¢«æ‹’ç» - ' + error.message;
                statusEl.style.background = '#ffebee';
                console.error('æƒé™é”™è¯¯:', error);
            }
        }

        async function toggleRecording() {
            const btn = document.getElementById('record-btn');
            const statusEl = document.getElementById('recording-status');

            if (!isRecording) {
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 16000
                        } 
                    });

                    mediaRecorder = new MediaRecorder(audioStream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });

                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.textContent = 'åœæ­¢å½•éŸ³';
                    btn.classList.add('recording');
                    statusEl.textContent = 'çŠ¶æ€: ğŸ”´ æ­£åœ¨å½•éŸ³...';
                    statusEl.style.background = '#ffebee';
                } catch (error) {
                    statusEl.textContent = 'çŠ¶æ€: âŒ å½•éŸ³å¤±è´¥ - ' + error.message;
                    console.error('å½•éŸ³é”™è¯¯:', error);
                }
            } else {
                mediaRecorder.stop();
                audioStream.getTracks().forEach(track => track.stop());
                isRecording = false;
                btn.textContent = 'å¼€å§‹å½•éŸ³';
                btn.classList.remove('recording');
                statusEl.textContent = 'çŠ¶æ€: âœ… å½•éŸ³å·²åœæ­¢';
                statusEl.style.background = '#e8f5e9';
            }
        }

        async function testRecognition() {
            const statusEl = document.getElementById('recognition-status');
            const resultEl = document.getElementById('recognition-result');

            try {
                statusEl.textContent = 'çŠ¶æ€: å¼€å§‹å½•éŸ³...';
                resultEl.textContent = 'è¯·è¯´è¯...';
                resultEl.classList.remove('error');

                // å¼€å§‹å½•éŸ³
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    } 
                });

                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    try {
                        statusEl.textContent = 'çŠ¶æ€: ä¸Šä¼ å¹¶è¯†åˆ«ä¸­...';
                        
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        console.log('å½•éŸ³å¤§å°:', audioBlob.size, 'bytes');

                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('userId', '1');
                        formData.append('sessionId', '1');
                        formData.append('language', 'zh-CN');

                        const response = await fetch('http://localhost:10088/api/voice/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        console.log('APIå“åº”:', data);

                        if (data.success) {
                            statusEl.textContent = 'çŠ¶æ€: âœ… è¯†åˆ«æˆåŠŸ';
                            statusEl.style.background = '#e8f5e9';
                            resultEl.textContent = 'è¯†åˆ«ç»“æœ: ' + (data.recognizedText || '(ç©º)');
                        } else {
                            throw new Error(data.errorMessage || 'è¯†åˆ«å¤±è´¥');
                        }
                    } catch (error) {
                        statusEl.textContent = 'çŠ¶æ€: âŒ è¯†åˆ«å¤±è´¥';
                        statusEl.style.background = '#ffebee';
                        resultEl.textContent = 'é”™è¯¯: ' + error.message;
                        resultEl.classList.add('error');
                        console.error('è¯†åˆ«é”™è¯¯:', error);
                    } finally {
                        audioStream.getTracks().forEach(track => track.stop());
                    }
                };

                mediaRecorder.start();
                statusEl.textContent = 'çŠ¶æ€: ğŸ”´ å½•éŸ³ä¸­ (3ç§’åè‡ªåŠ¨åœæ­¢)...';

                // 3ç§’åè‡ªåŠ¨åœæ­¢
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 3000);

            } catch (error) {
                statusEl.textContent = 'çŠ¶æ€: âŒ æµ‹è¯•å¤±è´¥';
                statusEl.style.background = '#ffebee';
                resultEl.textContent = 'é”™è¯¯: ' + error.message;
                resultEl.classList.add('error');
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }

        async function testAPI() {
            const statusEl = document.getElementById('api-status');
            try {
                statusEl.textContent = 'çŠ¶æ€: æµ‹è¯•ä¸­...';
                const response = await fetch('http://localhost:10088/api/voice/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.ok || response.status === 400) {
                    statusEl.textContent = 'çŠ¶æ€: âœ… APIå¯è®¿é—® (HTTP ' + response.status + ')';
                    statusEl.style.background = '#e8f5e9';
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            } catch (error) {
                statusEl.textContent = 'çŠ¶æ€: âŒ APIä¸å¯è®¿é—® - ' + error.message;
                statusEl.style.background = '#ffebee';
                console.error('APIé”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        window.onload = () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½');
            }
        };
    </script>
</body>
</html>
