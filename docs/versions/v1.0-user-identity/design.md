# v1.0 æ— æ³¨å†Œç”¨æˆ·èº«ä»½è¯†åˆ«ç³»ç»Ÿ - è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-01-15  
**çŠ¶æ€**: ğŸ“ è§„åˆ’ä¸­  
**è®¾è®¡è´Ÿè´£äºº**: VoiceBoxæ¶æ„å›¢é˜Ÿ

---

## ğŸ“ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Webå‰ç«¯ (Vue 3)    â”‚    å°ç¨‹åºå‰ç«¯ (å¾®ä¿¡åŸç”Ÿ)              â”‚
â”‚  - è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ       â”‚   - å¾®ä¿¡ç™»å½•                          â”‚
â”‚  - æœ¬åœ°å­˜å‚¨ç®¡ç†       â”‚   - è®¾å¤‡ä¿¡æ¯æ”¶é›†                      â”‚
â”‚  - ç”¨æˆ·èº«ä»½ç®¡ç†       â”‚   - ç”¨æˆ·æˆæƒ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         APIç½‘å…³å±‚                             â”‚
â”‚  - è¯·æ±‚è·¯ç”±                                                   â”‚
â”‚  - èº«ä»½éªŒè¯                                                   â”‚
â”‚  - é™æµæ§åˆ¶                                                   â”‚
â”‚  - æ—¥å¿—è®°å½•                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨æœåŠ¡å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·èº«ä»½æœåŠ¡         â”‚   è®¾å¤‡ç®¡ç†æœåŠ¡                        â”‚
â”‚  - ç”¨æˆ·è¯†åˆ«          â”‚   - è®¾å¤‡æŒ‡çº¹éªŒè¯                      â”‚
â”‚  - IDç”Ÿæˆ            â”‚   - è®¾å¤‡ç»‘å®š                          â”‚
â”‚  - èº«ä»½ç»‘å®š          â”‚   - è®¾å¤‡åˆ—è¡¨ç®¡ç†                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®è®¿é—®å±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Redisç¼“å­˜          â”‚    MySQLæ•°æ®åº“                        â”‚
â”‚  - ç”¨æˆ·ä¿¡æ¯ç¼“å­˜       â”‚   - ç”¨æˆ·è¡¨                            â”‚
â”‚  - ä¼šè¯ç¼“å­˜          â”‚   - è®¾å¤‡è¡¨                            â”‚
â”‚  - çƒ­ç‚¹æ•°æ®          â”‚   - ä¼šè¯è¡¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰å‹

**åç«¯**:
- æ¡†æ¶: Spring Boot 2.7+
- æ•°æ®åº“: MySQL 8.0+
- ç¼“å­˜: Redis 6.0+
- æ„å»ºå·¥å…·: Maven 3.8+

**å‰ç«¯**:
- æ¡†æ¶: Vue 3 + Vite
- çŠ¶æ€ç®¡ç†: Pinia
- HTTPå®¢æˆ·ç«¯: Axios
- åŠ å¯†åº“: CryptoJS

**å°ç¨‹åº**:
- æ¡†æ¶: å¾®ä¿¡å°ç¨‹åºåŸç”Ÿ
- ç½‘ç»œè¯·æ±‚: wx.request
- å­˜å‚¨: wx.storage


## ğŸ—„ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id VARCHAR(20) PRIMARY KEY COMMENT 'ç”¨æˆ·IDï¼Œæ ¼å¼ï¼šu_xxxxxxxxxxxxxx',
    device_fingerprint VARCHAR(64) UNIQUE COMMENT 'è®¾å¤‡æŒ‡çº¹SHA-256å“ˆå¸Œå€¼',
    phone_number VARCHAR(20) COMMENT 'æ‰‹æœºå·ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
    phone_number_hash VARCHAR(64) COMMENT 'æ‰‹æœºå·å“ˆå¸Œå€¼ï¼ˆç”¨äºæŸ¥è¯¢ï¼‰',
    nickname VARCHAR(100) COMMENT 'ç”¨æˆ·æ˜µç§°',
    avatar_url VARCHAR(500) COMMENT 'å¤´åƒURL',
    
    -- è®¾å¤‡ä¿¡æ¯
    ip_address VARCHAR(45) COMMENT 'æ³¨å†ŒIPåœ°å€',
    user_agent TEXT COMMENT 'æµè§ˆå™¨UserAgent',
    platform VARCHAR(50) COMMENT 'å¹³å°ï¼šweb/wechat-miniprogram/mobile-web',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    last_seen_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€åæ´»è·ƒæ—¶é—´',
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
    is_deleted BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦åˆ é™¤',
    
    -- ç´¢å¼•
    INDEX idx_device_fingerprint (device_fingerprint),
    INDEX idx_phone_number_hash (phone_number_hash),
    INDEX idx_created_at (created_at),
    INDEX idx_last_seen_at (last_seen_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### ç”¨æˆ·è®¾å¤‡è¡¨ (user_devices)

```sql
CREATE TABLE user_devices (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(20) NOT NULL COMMENT 'ç”¨æˆ·ID',
    device_fingerprint VARCHAR(64) NOT NULL COMMENT 'è®¾å¤‡æŒ‡çº¹',
    device_name VARCHAR(100) COMMENT 'è®¾å¤‡åç§°',
    device_type VARCHAR(50) COMMENT 'è®¾å¤‡ç±»å‹ï¼šdesktop/mobile/tablet',
    
    -- è®¾å¤‡è¯¦ç»†ä¿¡æ¯
    platform VARCHAR(50) COMMENT 'å¹³å°',
    browser VARCHAR(50) COMMENT 'æµè§ˆå™¨',
    os VARCHAR(50) COMMENT 'æ“ä½œç³»ç»Ÿ',
    screen_resolution VARCHAR(20) COMMENT 'å±å¹•åˆ†è¾¨ç‡',
    
    -- çŠ¶æ€
    is_primary BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸»è®¾å¤‡',
    is_trusted BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ä¿¡è®¾å¤‡',
    last_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ç»‘å®šæ—¶é—´',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_device (user_id, device_fingerprint),
    INDEX idx_user_id (user_id),
    INDEX idx_device_fingerprint (device_fingerprint)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è®¾å¤‡è¡¨';
```

### ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)

```sql
CREATE TABLE user_sessions (
    id VARCHAR(32) PRIMARY KEY COMMENT 'ä¼šè¯ID',
    user_id VARCHAR(20) NOT NULL COMMENT 'ç”¨æˆ·ID',
    device_fingerprint VARCHAR(64) COMMENT 'è®¾å¤‡æŒ‡çº¹',
    
    -- ä¼šè¯ä¿¡æ¯
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'UserAgent',
    
    -- æ—¶é—´
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    expires_at TIMESTAMP COMMENT 'è¿‡æœŸæ—¶é—´',
    last_activity_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´',
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ¿€æ´»',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at),
    INDEX idx_device_fingerprint (device_fingerprint)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¼šè¯è¡¨';
```


## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. è®¾å¤‡æŒ‡çº¹ç”Ÿæˆå™¨ (DeviceFingerprintGenerator)

**èŒè´£**: ç”Ÿæˆç¨³å®šã€å”¯ä¸€çš„è®¾å¤‡æŒ‡çº¹

**å®ç°æ–¹æ¡ˆ**:

```javascript
// å‰ç«¯å®ç°
class DeviceFingerprintGenerator {
  async generate() {
    const components = await this.collectComponents()
    const fingerprint = this.hashComponents(components)
    return fingerprint
  }
  
  async collectComponents() {
    return {
      canvas: this.getCanvasFingerprint(),
      webgl: this.getWebGLFingerprint(),
      audio: await this.getAudioFingerprint(),
      screen: this.getScreenInfo(),
      timezone: this.getTimezoneInfo(),
      language: this.getLanguageInfo(),
      platform: this.getPlatformInfo(),
      plugins: this.getPluginsInfo(),
      fonts: this.getFontsInfo()
    }
  }
  
  hashComponents(components) {
    const json = JSON.stringify(components)
    return CryptoJS.SHA256(json).toString()
  }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:
- CanvasæŒ‡çº¹: ç»˜åˆ¶ç‰¹å®šæ–‡æœ¬å’Œå›¾å½¢ï¼Œè·å–åƒç´ æ•°æ®
- WebGLæŒ‡çº¹: è·å–GPUå‚å•†ã€æ¸²æŸ“å™¨ä¿¡æ¯
- éŸ³é¢‘æŒ‡çº¹: ç”ŸæˆéŸ³é¢‘ä¿¡å·ï¼Œåˆ†æé¢‘è°±ç‰¹å¾
- å±å¹•æŒ‡çº¹: åˆ†è¾¨ç‡ã€è‰²æ·±ã€åƒç´ æ¯”
- ç³»ç»ŸæŒ‡çº¹: æ—¶åŒºã€è¯­è¨€ã€å¹³å°ã€æ’ä»¶

### 2. ç”¨æˆ·èº«ä»½æœåŠ¡ (UserIdentityService)

**èŒè´£**: ç®¡ç†ç”¨æˆ·èº«ä»½è¯†åˆ«å’Œç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒæ–¹æ³•**:

```java
@Service
public class UserIdentityService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private DeviceRepository deviceRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è·å–æˆ–åˆ›å»ºç”¨æˆ·ID
     * è¯†åˆ«ä¼˜å…ˆçº§: æœ¬åœ°å­˜å‚¨ > è®¾å¤‡æŒ‡çº¹ > æ‰‹æœºå· > åˆ›å»ºæ–°ç”¨æˆ·
     */
    public UserIdentityResponse getOrCreateUserId(UserIdentityRequest request) {
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        String cachedUserId = getCachedUserId(request.getDeviceFingerprint());
        if (cachedUserId != null) {
            return buildResponse(cachedUserId, false);
        }
        
        // 2. å°è¯•é€šè¿‡è®¾å¤‡æŒ‡çº¹æŸ¥æ‰¾
        Optional<User> userByFingerprint = userRepository
            .findByDeviceFingerprint(request.getDeviceFingerprint());
        if (userByFingerprint.isPresent()) {
            User user = userByFingerprint.get();
            cacheUserId(request.getDeviceFingerprint(), user.getId());
            updateLastSeen(user.getId(), request);
            return buildResponse(user.getId(), false);
        }
        
        // 3. å°è¯•é€šè¿‡æ‰‹æœºå·æŸ¥æ‰¾
        if (request.getPhoneNumber() != null) {
            String phoneHash = hashPhoneNumber(request.getPhoneNumber());
            Optional<User> userByPhone = userRepository
                .findByPhoneNumberHash(phoneHash);
            if (userByPhone.isPresent()) {
                User user = userByPhone.get();
                // ç»‘å®šæ–°è®¾å¤‡
                bindDevice(user.getId(), request);
                cacheUserId(request.getDeviceFingerprint(), user.getId());
                return buildResponse(user.getId(), false);
            }
        }
        
        // 4. åˆ›å»ºæ–°ç”¨æˆ·
        String newUserId = createNewUser(request);
        cacheUserId(request.getDeviceFingerprint(), newUserId);
        return buildResponse(newUserId, true);
    }
    
    /**
     * ç”Ÿæˆç”¨æˆ·ID
     */
    private String generateUserId() {
        String id;
        do {
            id = "u_" + RandomStringUtils.randomAlphanumeric(14);
        } while (userRepository.existsById(id));
        return id;
    }
    
    /**
     * åˆ›å»ºæ–°ç”¨æˆ·
     */
    private String createNewUser(UserIdentityRequest request) {
        String userId = generateUserId();
        
        User user = User.builder()
            .id(userId)
            .deviceFingerprint(request.getDeviceFingerprint())
            .ipAddress(request.getIpAddress())
            .userAgent(request.getUserAgent())
            .platform(request.getPlatform())
            .createdAt(LocalDateTime.now())
            .lastSeenAt(LocalDateTime.now())
            .isActive(true)
            .isDeleted(false)
            .build();
            
        userRepository.save(user);
        
        // åˆ›å»ºè®¾å¤‡è®°å½•
        createDeviceRecord(userId, request, true);
        
        return userId;
    }
    
    /**
     * ç»‘å®šè®¾å¤‡
     */
    private void bindDevice(String userId, UserIdentityRequest request) {
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç»‘å®š
        boolean exists = deviceRepository.existsByUserIdAndDeviceFingerprint(
            userId, request.getDeviceFingerprint()
        );
        
        if (!exists) {
            createDeviceRecord(userId, request, false);
        }
    }
}
```

### 3. è®¾å¤‡ç®¡ç†æœåŠ¡ (DeviceManagementService)

**èŒè´£**: ç®¡ç†ç”¨æˆ·è®¾å¤‡ä¿¡æ¯

```java
@Service
public class DeviceManagementService {
    
    @Autowired
    private DeviceRepository deviceRepository;
    
    /**
     * è·å–ç”¨æˆ·æ‰€æœ‰è®¾å¤‡
     */
    public List<UserDevice> getUserDevices(String userId) {
        return deviceRepository.findByUserIdOrderByLastUsedAtDesc(userId);
    }
    
    /**
     * è®¾ç½®ä¸»è®¾å¤‡
     */
    public void setPrimaryDevice(String userId, String deviceFingerprint) {
        // å–æ¶ˆå…¶ä»–è®¾å¤‡çš„ä¸»è®¾å¤‡çŠ¶æ€
        deviceRepository.updatePrimaryStatusByUserId(userId, false);
        
        // è®¾ç½®æ–°çš„ä¸»è®¾å¤‡
        deviceRepository.updatePrimaryStatusByUserIdAndFingerprint(
            userId, deviceFingerprint, true
        );
    }
    
    /**
     * è§£ç»‘è®¾å¤‡
     */
    public void unbindDevice(String userId, String deviceFingerprint) {
        deviceRepository.deleteByUserIdAndDeviceFingerprint(
            userId, deviceFingerprint
        );
    }
}
```

