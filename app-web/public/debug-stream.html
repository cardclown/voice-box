<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼å“åº”è°ƒè¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
        }
        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        button:hover {
            background: #1177bb;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .section h2 {
            margin-top: 0;
            color: #4ec9b0;
            font-size: 16px;
        }
        #logs {
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-line {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-info { color: #4ec9b0; }
        .log-data { color: #ce9178; }
        .log-event { color: #dcdcaa; }
        .log-error { color: #f48771; }
        #output {
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
        }
        .cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #4ec9b0;
            margin-left: 2px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .stats {
            color: #858585;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” VoiceBox æµå¼å“åº”è°ƒè¯•å·¥å…·</h1>
        
        <button onclick="test()">å¼€å§‹æµ‹è¯•</button>
        <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        
        <div class="section">
            <h2>ğŸ“Š è¾“å‡ºç»“æœ</h2>
            <div id="output">ç­‰å¾…æµ‹è¯•...</div>
            <div class="stats" id="stats"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let startTime = null;
        let tokenCount = 0;
        
        function log(message, type = 'info') {
            const logsEl = document.getElementById('logs');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(line);
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('output').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('stats').textContent = '';
        }
        
        async function test() {
            clearLogs();
            const outputEl = document.getElementById('output');
            const statsEl = document.getElementById('stats');
            
            outputEl.innerHTML = '<span class="cursor"></span>';
            tokenCount = 0;
            startTime = Date.now();
            
            log('ğŸš€ å¼€å§‹æµ‹è¯•æµå¼å“åº”', 'info');
            log('ğŸ“ URL: http://localhost:10088/api/chat/stream', 'info');
            
            try {
                log('ğŸ“¤ å‘é€è¯·æ±‚...', 'info');
                const response = await fetch('http://localhost:10088/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        text: 'æ•°åˆ°3',
                        model: 'doubao',
                        deviceInfo: 'debug-test'
                    })
                });
                
                log(`âœ… å“åº”çŠ¶æ€: ${response.status}`, 'info');
                log(`ğŸ“‹ Content-Type: ${response.headers.get('content-type')}`, 'info');
                log(`ğŸ”“ CORS: ${response.headers.get('access-control-allow-origin')}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullText = '';
                let currentEvent = null;
                let chunkCount = 0;
                
                log('ğŸ“– å¼€å§‹è¯»å–æµ...', 'info');
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        log('ğŸ æµç»“æŸ', 'info');
                        break;
                    }
                    
                    chunkCount++;
                    const chunk = decoder.decode(value, { stream: true });
                    log(`ğŸ“¦ æ”¶åˆ°æ•°æ®å— #${chunkCount} (${chunk.length} å­—èŠ‚)`, 'data');
                    
                    buffer += chunk;
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        
                        log(`ğŸ“„ åŸå§‹è¡Œ: "${line}"`, 'data');
                        
                        if (line.startsWith('event:')) {
                            currentEvent = line.slice(6).trim();
                            log(`ğŸ¯ äº‹ä»¶ç±»å‹: ${currentEvent}`, 'event');
                        } else if (line.startsWith('data:')) {
                            const data = line.slice(5).trim();
                            log(`ğŸ“Š æ•°æ®å†…å®¹: ${data.substring(0, 50)}...`, 'data');
                            
                            if (data === '[DONE]') {
                                log('âœ… æ”¶åˆ°ç»“æŸæ ‡è®°', 'info');
                                break;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                
                                if (currentEvent === 'session') {
                                    log(`ğŸ†” ä¼šè¯ID: ${parsed.sessionId}`, 'info');
                                } else if (currentEvent === 'delta') {
                                    if (parsed.text) {
                                        tokenCount++;
                                        fullText += parsed.text;
                                        log(`ğŸ’¬ Token #${tokenCount}: "${parsed.text}"`, 'data');
                                        
                                        // å®æ—¶æ›´æ–°æ˜¾ç¤º
                                        outputEl.innerHTML = fullText + '<span class="cursor"></span>';
                                        
                                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                                        statsEl.textContent = `å·²æ¥æ”¶ ${tokenCount} ä¸ª tokenï¼Œè€—æ—¶ ${elapsed} ç§’`;
                                    }
                                }
                                
                                currentEvent = null;
                            } catch (e) {
                                log(`âŒ JSON è§£æå¤±è´¥: ${e.message}`, 'error');
                                log(`   æ•°æ®: ${data.substring(0, 100)}`, 'error');
                            }
                        }
                    }
                }
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                log(`ğŸ‰ å®Œæˆï¼å…± ${tokenCount} ä¸ª tokenï¼Œ${chunkCount} ä¸ªæ•°æ®å—ï¼Œè€—æ—¶ ${duration} ç§’`, 'info');
                outputEl.innerHTML = fullText;
                
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                log(`   å †æ ˆ: ${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>

