---
inclusion: always
---

# 测试要求规范

## 核心原则

**每次代码变更后必须立即进行测试验证**，确保：
1. 变更的功能正常工作
2. 关联的功能没有被破坏
3. 整体系统稳定性

## ⚠️ 强制要求：变更即测试

**任何代码变更操作完成后，必须立即测试验证该变更是否生效**

### 为什么必须立即测试

1. **及时发现问题** - 问题越早发现，修复成本越低
2. **确认变更生效** - 避免"改了但没生效"的尴尬
3. **防止遗忘** - 改完就测，不会忘记测试
4. **保证质量** - 每次变更都经过验证
5. **提高效率** - 立即反馈，快速迭代

### 测试时机

```
代码变更
    ↓
保存文件
    ↓
⚠️ 立即测试（不要等待）
    ↓
验证变更是否生效
    ↓
测试通过？
    ├─ 是 → 继续下一步
    └─ 否 → 立即修复，重新测试
```

### 不同类型变更的测试要求

#### 1. 修改代码文件

```bash
# 修改后立即测试
# 后端代码
mvn clean install          # 编译
mvn spring-boot:run        # 启动
# 测试 API 端点

# 前端代码
npm run dev                # 启动
# 在浏览器中测试变更的功能
```

#### 2. 修改配置文件

```bash
# 修改配置后立即验证
cat config.properties      # 确认修改已保存
./restart-all.sh           # 重启服务
./status.sh                # 检查服务状态
# 测试受影响的功能
```

#### 3. 修改数据库

```bash
# 执行 SQL 后立即验证
mysql -h 129.211.180.183 -u voicebox -pvoicebox123 voicebox_db -e "SHOW TABLES;"
mysql -h 129.211.180.183 -u voicebox -pvoicebox123 voicebox_db -e "DESCRIBE new_table;"
# 测试使用该表的功能
```

#### 4. 修改依赖

```bash
# 修改 pom.xml 或 package.json 后
mvn clean install          # 重新安装依赖
# 或
npm install                # 重新安装依赖
# 启动并测试
```

#### 5. 修改脚本

```bash
# 修改脚本后立即测试
chmod +x script.sh         # 确保有执行权限
./script.sh                # 执行脚本
# 检查脚本输出和结果
```

### 测试验证清单

每次变更后，按此清单验证：

- [ ] **文件已保存** - 确认修改已保存到磁盘
- [ ] **编译成功** - 代码能够编译通过（如适用）
- [ ] **服务启动** - 服务能够正常启动
- [ ] **变更生效** - 修改的功能确实生效了
- [ ] **功能正常** - 变更的功能工作正常
- [ ] **无新错误** - 没有引入新的错误
- [ ] **关联功能** - 相关功能没有被破坏

### 快速验证方法

#### 后端变更

```bash
# 1. 快速编译测试
mvn clean compile

# 2. 运行单元测试
mvn test -Dtest=ChangedClass*

# 3. 启动服务
mvn spring-boot:run

# 4. 测试 API
curl http://localhost:10088/api/endpoint
```

#### 前端变更

```bash
# 1. 启动开发服务器（热重载）
npm run dev

# 2. 在浏览器中测试
# - 打开 http://localhost:5173
# - 操作变更的功能
# - 检查控制台是否有错误

# 3. 检查构建
npm run build
```

#### 配置变更

```bash
# 1. 验证配置语法
cat config.properties | grep "变更的配置项"

# 2. 重启服务
./restart-all.sh

# 3. 检查日志
tail -f backend.log | grep "配置项"

# 4. 测试功能
# 测试受配置影响的功能
```

### 常见错误：忘记测试

#### ❌ 错误做法

```bash
# 修改代码
vim SomeService.java

# 保存并退出
:wq

# 直接提交（没有测试！）
git add .
git commit -m "修复bug"
git push

# 结果：部署后发现代码有问题
```

#### ✅ 正确做法

```bash
# 修改代码
vim SomeService.java

# 保存并退出
:wq

# ⚠️ 立即测试
mvn clean install
mvn spring-boot:run

# 测试变更的功能
curl http://localhost:10088/api/test

# 确认工作正常后再提交
git add .
git commit -m "修复bug"
git push
```

### 测试失败时的处理

如果测试发现问题：

```bash
# 1. 不要忽略问题
# 2. 不要提交有问题的代码
# 3. 立即修复

# 修复代码
vim SomeService.java

# 重新测试
mvn clean install
mvn spring-boot:run

# 再次验证
curl http://localhost:10088/api/test

# 确认修复后再继续
```

### 自动化测试提醒

可以使用 Git hooks 强制测试：

```bash
# .git/hooks/pre-commit
#!/bin/bash

echo "运行测试..."

# 后端测试
cd app-device
mvn test
if [ $? -ne 0 ]; then
    echo "❌ 后端测试失败，请修复后再提交"
    exit 1
fi

# 前端测试
cd ../app-web
npm run test
if [ $? -ne 0 ]; then
    echo "❌ 前端测试失败，请修复后再提交"
    exit 1
fi

echo "✅ 所有测试通过"
exit 0
```

---

## 强制测试规则

### 1. 前端代码变更后

#### 必须测试的内容

**直接变更的功能**
- ✅ 修改的组件是否正常渲染
- ✅ 修改的交互是否正常响应
- ✅ 修改的样式是否正确显示
- ✅ 修改的 API 调用是否成功

**关联功能测试**
- ✅ 父组件是否正常工作
- ✅ 子组件是否正常工作
- ✅ 同级组件是否受影响
- ✅ 路由跳转是否正常
- ✅ 状态管理是否正常

**通用功能测试**
- ✅ Toast 通知是否正常
- ✅ 错误处理是否正常
- ✅ 加载状态是否正常
- ✅ 响应式布局是否正常

#### 测试步骤

```bash
# 1. 启动前端开发服务器
cd app-web
npm run dev

# 2. 在浏览器中测试
# - 打开 http://localhost:5173
# - 测试变更的功能
# - 测试关联的功能
# - 检查浏览器控制台是否有错误

# 3. 运行单元测试（如果有）
npm run test

# 4. 检查构建是否成功
npm run build
```

### 2. 后端代码变更后

#### 必须测试的内容

**直接变更的功能**
- ✅ 修改的 API 端点是否正常响应
- ✅ 修改的业务逻辑是否正确
- ✅ 修改的数据库操作是否成功
- ✅ 修改的数据验证是否有效

**关联功能测试**
- ✅ 调用该服务的其他服务是否正常
- ✅ 依赖的服务是否正常工作
- ✅ 数据库事务是否正确
- ✅ 缓存是否正确更新

**通用功能测试**
- ✅ 异常处理是否正常
- ✅ 日志记录是否正确
- ✅ 权限验证是否有效
- ✅ 性能是否符合预期

#### 测试步骤

```bash
# 1. 编译项目
mvn clean install -DskipTests

# 2. 启动后端服务
cd app-device
mvn spring-boot:run

# 3. 使用 API 工具测试（Postman/curl）
# - 测试变更的 API 端点
# - 测试关联的 API 端点
# - 检查响应数据是否正确
# - 检查数据库数据是否正确

# 4. 运行单元测试
mvn test

# 5. 检查日志
tail -f backend.log
```

### 3. 全栈功能变更后

#### 必须测试的内容

**端到端测试**
- ✅ 前端到后端的完整流程
- ✅ 数据的完整生命周期
- ✅ 用户操作的完整场景
- ✅ 错误场景的处理

**集成测试**
- ✅ 前后端数据格式是否匹配
- ✅ API 调用是否成功
- ✅ 数据库操作是否正确
- ✅ 缓存是否同步

#### 测试步骤

```bash
# 1. 启动完整环境
./start-all.sh

# 2. 等待服务启动
./status.sh

# 3. 进行端到端测试
# - 在浏览器中完成完整的用户操作流程
# - 验证数据在前端、后端、数据库中的一致性
# - 测试各种边界情况和错误场景

# 4. 检查日志
tail -f backend.log
tail -f frontend.log
```

---

## 测试检查清单

### 代码变更前

- [ ] 了解要修改的功能
- [ ] 识别关联的功能模块
- [ ] 确认测试范围
- [ ] 准备测试数据

### 代码变更后

- [ ] 编译/构建成功
- [ ] 直接变更的功能测试通过
- [ ] 关联功能测试通过
- [ ] 无控制台错误
- [ ] 无后端异常日志
- [ ] 数据库数据正确
- [ ] 性能无明显下降

### 提交代码前

- [ ] 所有测试通过
- [ ] 代码已格式化
- [ ] 无调试代码残留
- [ ] 文档已更新（如需要）

---

## 常见测试场景

### 聊天功能变更

**必须测试**：
1. 发送消息
2. 接收消息
3. 消息历史加载
4. 会话切换
5. 用户身份识别
6. 个性化响应（如果启用）

### 用户画像功能变更

**必须测试**：
1. 画像数据获取
2. 画像数据展示
3. 画像数据更新
4. 特征提取
5. 标签生成
6. 学习反馈

### API 端点变更

**必须测试**：
1. 正常请求响应
2. 参数验证
3. 错误处理
4. 权限验证
5. 数据格式
6. 性能表现

### 数据库变更

**必须测试**：
1. 数据插入
2. 数据查询
3. 数据更新
4. 数据删除
5. 事务处理
6. 索引性能

### UI 组件变更

**必须测试**：
1. 组件渲染
2. 用户交互
3. 数据绑定
4. 事件处理
5. 样式显示
6. 响应式布局

---

## 测试工具

### 前端测试

- **浏览器开发者工具**: 检查控制台错误、网络请求
- **Vue DevTools**: 检查组件状态、事件
- **Vitest**: 单元测试框架
- **手动测试**: 实际操作验证

### 后端测试

- **Postman/Insomnia**: API 测试
- **curl**: 命令行 API 测试
- **JUnit**: 单元测试框架
- **MySQL Workbench**: 数据库验证
- **日志文件**: 错误和异常检查

### 集成测试

- **浏览器**: 端到端测试
- **数据库客户端**: 数据验证
- **日志监控**: 实时错误检查

---

## 测试失败处理

### 发现问题时

1. **记录问题**
   - 截图或录屏
   - 记录错误信息
   - 记录复现步骤

2. **分析问题**
   - 检查控制台错误
   - 检查后端日志
   - 检查数据库数据
   - 检查网络请求

3. **修复问题**
   - 定位问题代码
   - 修复问题
   - 重新测试

4. **验证修复**
   - 重新运行所有相关测试
   - 确认问题已解决
   - 确认没有引入新问题

---

## 测试报告

### 每次变更后应记录

```markdown
## 测试报告

**变更内容**: [简要描述]
**变更文件**: [列出修改的文件]
**测试时间**: [YYYY-MM-DD HH:mm]

### 直接功能测试
- [x] 功能1: 通过
- [x] 功能2: 通过

### 关联功能测试
- [x] 关联功能1: 通过
- [x] 关联功能2: 通过

### 发现的问题
- 无 / [列出问题]

### 测试结论
✅ 通过 / ❌ 失败
```

---

## 自动化测试建议

### 前端

```bash
# 在 package.json 中添加测试脚本
"scripts": {
  "test": "vitest run",
  "test:watch": "vitest",
  "test:coverage": "vitest run --coverage"
}
```

### 后端

```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=UserProfileServiceTest

# 生成测试报告
mvn test jacoco:report
```

---

## 持续集成建议

未来可以考虑：
1. 设置 Git hooks，提交前自动运行测试
2. 配置 CI/CD 流程，自动运行测试
3. 设置测试覆盖率要求
4. 自动化端到端测试

---

## 注意事项

1. **不要跳过测试**: 即使是"小改动"也可能引起意外问题
2. **测试要全面**: 不仅测试正常流程，也要测试异常情况
3. **记录测试结果**: 便于追踪和问题排查
4. **及时修复问题**: 不要积累技术债务
5. **保持测试环境**: 确保测试环境与生产环境一致

---

## 快速测试命令

```bash
# 完整测试流程
./stop-all.sh          # 停止旧服务
./start-all.sh         # 启动新服务
./status.sh            # 检查服务状态
# 然后在浏览器中进行功能测试

# 仅测试后端
cd app-device
mvn clean install
mvn spring-boot:run
# 使用 Postman 或 curl 测试 API

# 仅测试前端
cd app-web
npm run dev
# 在浏览器中测试
```
