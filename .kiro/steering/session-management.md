# 会话管理规范

## 核心原则

**当会话上下文过长时，应该主动新建会话来执行任务**，确保：
1. 避免上下文过载导致的性能问题
2. 保持对话焦点清晰
3. 提高响应速度和准确性
4. 减少token消耗

---

## 会话过长的判断标准

### 明确信号

以下情况表明会话已经过长，应该新建会话：

1. **打开文件过多** - 超过50个打开的文件
2. **对话轮次过多** - 超过30轮对话
3. **上下文切换频繁** - 在多个不相关的任务之间切换
4. **响应变慢** - 明显感觉到响应时间变长
5. **内容重复** - 开始重复之前说过的内容
6. **焦点模糊** - 不清楚当前的主要任务是什么

### 具体场景

#### 场景 1: 完成一个大功能后

```
✅ 已完成：情感语音模块开发
    ↓
🆕 新任务：开始测试和部署
    ↓
⚠️ 建议：新建会话
```

**原因**：
- 开发阶段的上下文（代码细节、调试信息）不再需要
- 测试阶段需要全新的焦点
- 避免混淆开发和测试的上下文

#### 场景 2: 切换到不同的模块

```
当前会话：正在处理情感语音模块
    ↓
新任务：需要修改聊天模块
    ↓
⚠️ 建议：新建会话
```

**原因**：
- 两个模块的代码和逻辑不同
- 避免上下文混淆
- 保持焦点清晰

#### 场景 3: 打开文件过多

```
当前打开文件：150+ 个
    ↓
新任务：需要查看更多文件
    ↓
⚠️ 建议：新建会话
```

**原因**：
- 过多的文件会占用大量上下文
- 影响响应速度
- 可能导致遗漏重要信息

#### 场景 4: 长时间调试后

```
已进行：2小时的调试和问题排查
    ↓
问题已解决
    ↓
新任务：继续开发新功能
    ↓
⚠️ 建议：新建会话
```

**原因**：
- 调试过程中的大量错误信息和尝试不再需要
- 新功能开发需要清晰的思路
- 避免被之前的问题影响

---

## 新建会话的最佳实践

### 1. 何时新建会话

**应该新建会话**：
- ✅ 完成一个大的功能模块后
- ✅ 切换到完全不同的任务
- ✅ 打开文件超过50个
- ✅ 对话超过30轮
- ✅ 感觉响应变慢或不准确
- ✅ 需要全新的视角来解决问题

**不需要新建会话**：
- ❌ 同一任务的连续步骤
- ❌ 相关文件的小修改
- ❌ 简单的问题咨询
- ❌ 快速的验证测试

### 2. 如何新建会话

#### 方法 A: 用户手动新建

```
1. 在当前会话中总结完成的工作
2. 记录下一步要做的事情
3. 点击"新建会话"按钮
4. 在新会话中说明要继续的任务
```

#### 方法 B: AI主动建议

当AI检测到会话过长时，应该主动建议：

```markdown
## 会话过长提醒

当前会话已经包含了大量上下文（150+个文件，40+轮对话）。

**建议**：新建一个会话来继续工作，这样可以：
- 提高响应速度
- 保持焦点清晰
- 减少上下文混淆

**下一步**：
1. 我可以总结当前完成的工作
2. 你新建一个会话
3. 在新会话中告诉我要继续的任务

是否需要我总结当前的工作？
```

### 3. 会话切换时的信息传递

#### 在旧会话中

**最后一条消息应该包含**：

```markdown
## 当前会话总结

### 已完成
- [列出完成的主要任务]

### 当前状态
- 代码状态：[编译通过/有错误]
- 测试状态：[通过/失败]
- 部署状态：[已部署/未部署]

### 下一步
- [列出接下来要做的事情]

### 重要文件
- [列出关键文件路径]

### 注意事项
- [列出需要注意的问题]

---

**建议在新会话中继续**
```

#### 在新会话中

**第一条消息应该包含**：

```markdown
继续之前的工作：[简要描述任务]

**上下文**：
- 项目：VoiceBox
- 模块：[模块名]
- 任务：[具体任务]

**当前状态**：
- [简要说明当前进度]

**需要做的**：
- [列出具体要做的事情]

请帮我 [具体请求]
```

---

## 会话管理策略

### 按功能模块划分会话

**推荐做法**：

```
会话 1: 情感语音模块 - 开发阶段
    ├─ 后端服务开发
    ├─ 数据库设计
    └─ API实现

会话 2: 情感语音模块 - 前端开发
    ├─ 组件开发
    ├─ 状态管理
    └─ UI集成

会话 3: 情感语音模块 - 测试和部署
    ├─ 单元测试
    ├─ 集成测试
    └─ 生产部署

会话 4: 聊天模块 - 功能增强
    └─ [新的任务]
```

### 按工作阶段划分会话

```
会话 1: 需求分析和设计
会话 2: 核心功能开发
会话 3: 测试和调试
会话 4: 部署和验证
会话 5: 优化和增强
```

---

## 会话过长的后果

### 性能问题

- **响应变慢** - 处理大量上下文需要更多时间
- **内存占用** - 大量文件和对话占用内存
- **Token消耗** - 每次请求都要处理所有上下文

### 质量问题

- **焦点模糊** - 不清楚当前的主要任务
- **信息遗漏** - 重要信息可能被忽略
- **上下文混淆** - 混淆不同任务的信息
- **重复内容** - 开始重复之前的建议

### 效率问题

- **决策困难** - 信息过多导致难以决策
- **沟通成本** - 需要更多轮对话来澄清
- **错误增加** - 容易出现理解偏差

---

## 实践建议

### 1. 定期检查会话状态

每完成一个大任务后，问自己：

- [ ] 打开的文件是否超过50个？
- [ ] 对话是否超过30轮？
- [ ] 是否要切换到不同的任务？
- [ ] 响应速度是否变慢？
- [ ] 是否感觉焦点不清晰？

如果有2个或以上的"是"，考虑新建会话。

### 2. 主动管理上下文

- **关闭不需要的文件** - 只保留当前任务相关的文件
- **总结阶段性成果** - 定期总结完成的工作
- **清理临时文件** - 删除调试和测试产生的临时文件
- **更新文档** - 将重要信息记录到文档中

### 3. 合理规划任务

- **拆分大任务** - 将大任务拆分成多个小任务
- **按模块组织** - 相关的任务在同一会话中完成
- **设置里程碑** - 每个里程碑后考虑新建会话

---

## 会话命名建议

为了方便管理，建议给会话起有意义的名字：

**好的命名**：
- ✅ "情感语音模块 - 后端开发"
- ✅ "聊天功能 - Bug修复"
- ✅ "部署到生产环境"
- ✅ "性能优化 - 数据库查询"

**不好的命名**：
- ❌ "继续工作"
- ❌ "修复问题"
- ❌ "开发"
- ❌ "测试"

---

## 自动化规则（强制执行）

### ⚠️ 会话过长自动处理规则

**当检测到会话过长时，AI 必须主动建议新建会话**

#### 触发条件（满足任一即触发）

```python
# 自动触发新建会话建议的条件
if (open_files > 50 or           # 打开文件超过 50 个
    conversation_turns > 30 or   # 对话轮次超过 30 轮
    context_switches > 5 or      # 上下文切换超过 5 次
    response_time > threshold):  # 响应时间明显变慢
    
    # 必须执行：建议新建会话
    suggest_new_session()
```

#### 严格触发条件（必须新建会话）

```python
# 强制要求新建会话的条件
if (open_files > 100 or          # 打开文件超过 100 个
    conversation_turns > 50 or   # 对话轮次超过 50 轮
    context_switches > 10):      # 上下文切换超过 10 次
    
    # 必须执行：强制建议新建会话，不继续当前会话
    force_new_session()
```

### AI 行为规范

#### 1. 检测到会话过长时

**必须执行的步骤**：

```markdown
1. 立即停止当前任务
2. 输出会话过长警告
3. 总结当前会话的工作
4. 明确建议用户新建会话
5. 提供新会话的启动指导
```

#### 2. 提醒模板（标准格式）

```markdown
⚠️ **会话过长警告**

当前会话已经过长，影响效率和准确性：
- 打开文件：{count} 个（阈值：50）
- 对话轮次：{turns} 轮（阈值：30）
- 持续时间：{duration}

**强烈建议新建会话继续工作**

---

## 当前会话总结

### 已完成的工作
- [列出主要完成的任务]

### 当前状态
- 代码状态：[状态说明]
- 测试状态：[状态说明]
- 部署状态：[状态说明]

### 下一步计划
- [列出接下来要做的事情]

### 关键文件位置
- [列出重要文件路径]

---

**请新建一个会话，并在新会话中告诉我：**
"继续 [任务名称]，当前状态是 [状态]，需要 [具体需求]"

我会在新会话中快速恢复上下文并继续工作。
```

#### 3. 强制新建会话模板（严重过长）

```markdown
🚨 **会话严重过长 - 必须新建会话**

当前会话已经严重过长，继续使用会导致：
- 响应速度极慢
- 上下文混淆
- 错误率增加
- Token 消耗过大

**当前状态**：
- 打开文件：{count} 个（已超过 100）
- 对话轮次：{turns} 轮（已超过 50）

**我无法在当前会话中继续有效工作**

---

## 工作总结

[提供详细的工作总结]

---

**请立即新建会话**

在新会话中，只需简单说明：
"继续 [任务]，从 [当前状态] 开始"

我会重新开始，效率会大幅提升。
```

### 自动检测机制

#### 每次响应前检查

```python
def before_response():
    # 获取当前会话状态
    open_files = get_open_files_count()
    conversation_turns = get_conversation_turns()
    context_switches = get_context_switches()
    
    # 检查是否需要建议新建会话
    if should_suggest_new_session(open_files, conversation_turns, context_switches):
        output_new_session_suggestion()
        return  # 停止当前任务，等待用户新建会话
    
    # 检查是否必须新建会话
    if must_create_new_session(open_files, conversation_turns, context_switches):
        output_force_new_session_warning()
        return  # 拒绝继续，必须新建会话
    
    # 继续正常响应
    continue_normal_response()
```

### 实施细节

#### 1. 文件计数规则

- 只计算在编辑器中打开的文件
- 不计算仅被引用但未打开的文件
- 临时文件和测试文件也计入

#### 2. 对话轮次计数

- 每一次用户消息 + AI 响应 = 1 轮
- 不计算系统消息
- 从会话开始累计

#### 3. 上下文切换计数

- 从一个模块切换到另一个模块 = 1 次切换
- 从开发切换到测试/部署 = 1 次切换
- 从一个功能切换到另一个功能 = 1 次切换

### 例外情况

#### 不触发新建会话建议的情况

1. **紧急修复** - 正在修复生产环境的紧急问题
2. **即将完成** - 当前任务只剩最后 1-2 步
3. **用户明确要求** - 用户明确表示要在当前会话继续

#### 处理例外的方式

```markdown
⚠️ 注意：当前会话已过长（{count} 个文件，{turns} 轮对话）

我注意到你正在 [紧急修复/即将完成]，我会继续在当前会话工作。

但完成后，**强烈建议新建会话**进行后续工作。
```

---

## 常见问题

### Q: 新建会话会丢失上下文吗？

A: 不会。重要信息应该：
- 记录在文档中
- 提交到Git
- 在新会话开始时简要说明

### Q: 什么时候必须新建会话？

A: 当：
- 打开文件超过100个
- 对话超过50轮
- 响应明显变慢
- 开始出现理解错误

### Q: 如何在新会话中快速恢复上下文？

A: 
1. 简要说明项目和任务
2. 指出关键文件位置
3. 说明当前状态和下一步
4. AI会快速查看相关文件

### Q: 会话切换会影响工作连续性吗？

A: 不会。反而会：
- 提高焦点和效率
- 减少混淆和错误
- 加快响应速度

---

## 总结

**记住**：
- 会话过长会影响效率和质量
- 完成大任务后应该新建会话
- 切换模块时应该新建会话
- 主动管理上下文，保持焦点清晰

**口号**：
**新任务，新会话，新开始！**
