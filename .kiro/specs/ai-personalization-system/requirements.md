# AI个性化系统需求文档

## 简介

本文档定义了VoiceBox AI个性化系统的需求，该系统旨在为用户提供无需注册的智能对话体验，通过分析用户行为和对话习惯，自动适配AI的回应风格，并支持多种国内外大模型的灵活调用。

## 术语表

- **系统 (System)**: VoiceBox AI个性化系统
- **用户 (User)**: 使用VoiceBox服务的终端用户
- **设备指纹 (Device Fingerprint)**: 基于设备特征生成的唯一标识符
- **性格维度 (Personality Dimension)**: 基于大五人格模型的五个性格特征维度
- **AI角色 (AI Persona)**: 具有特定性格和对话风格的AI助手配置
- **对话特征 (Conversation Features)**: 从用户消息中提取的语言学和行为特征
- **系统提示词 (System Prompt)**: 用于指导AI模型行为的初始指令
- **代理服务器 (Proxy Server)**: 用于转发API请求的中间服务器
- **管理后台 (Admin Dashboard)**: 用于查看和管理用户数据的Web界面

## 需求

### 需求 1: 无注册用户身份识别

**用户故事**: 作为一个新用户，我希望无需注册登录就能使用服务，同时系统能记住我的使用历史，以便我下次访问时能继续之前的对话。

#### 验收标准

1. WHEN 用户首次访问系统 THEN 系统 SHALL 生成基于设备指纹的唯一用户标识符
2. WHEN 用户标识符生成后 THEN 系统 SHALL 将标识符存储在本地存储中以供后续访问使用
3. WHEN 用户再次访问系统 THEN 系统 SHALL 通过本地存储的标识符或设备指纹识别用户身份
4. WHEN 用户在小程序中授权手机号 THEN 系统 SHALL 将手机号与用户标识符绑定
5. WHEN 用户从不同设备访问但使用相同手机号 THEN 系统 SHALL 识别为同一用户并同步数据

### 需求 2: 设备指纹生成

**用户故事**: 作为系统开发者，我需要一个可靠的设备指纹生成机制，以便在用户未登录的情况下准确识别用户身份。

#### 验收标准

1. WHEN 生成设备指纹时 THEN 系统 SHALL 收集Canvas指纹、WebGL指纹、音频指纹、屏幕信息、时区、语言和平台信息
2. WHEN 收集到设备特征后 THEN 系统 SHALL 使用SHA-256算法生成64位十六进制哈希值
3. WHEN 设备指纹生成失败 THEN 系统 SHALL 使用降级方案生成基于时间戳和随机数的临时标识符
4. WHEN 用户清除浏览器数据 THEN 系统 SHALL 能够通过设备指纹重新识别用户
5. WHEN 同一设备的不同浏览器访问 THEN 系统 SHALL 生成不同的设备指纹

### 需求 3: 用户对话特征分析

**用户故事**: 作为系统，我需要分析用户的对话特征，以便了解用户的沟通风格和偏好，为个性化服务提供数据基础。

#### 验收标准

1. WHEN 用户发送消息 THEN 系统 SHALL 提取消息长度、词数、情感倾向、正式程度、问题数量、感叹号数量和表情符号数量
2. WHEN 分析消息情感时 THEN 系统 SHALL 返回-1到1之间的情感分数，负值表示负面情感，正值表示正面情感
3. WHEN 分析正式程度时 THEN 系统 SHALL 基于用词、标点符号和语气词返回0到1之间的正式度分数
4. WHEN 用户消息包含表情符号 THEN 系统 SHALL 准确统计表情符号数量
5. WHEN 累积足够的消息样本（至少10条）THEN 系统 SHALL 计算用户的平均对话特征

### 需求 4: 用户性格推断

**用户故事**: 作为系统，我需要基于用户的对话特征推断其性格维度，以便提供更符合用户性格的AI交互体验。

#### 验收标准

1. WHEN 用户消息样本达到10条以上 THEN 系统 SHALL 开始进行性格推断分析
2. WHEN 进行性格推断时 THEN 系统 SHALL 计算开放性、尽责性、外向性、宜人性和神经质五个维度的分数
3. WHEN 计算开放性分数时 THEN 系统 SHALL 基于话题多样性、词汇丰富度和问题数量进行评估
4. WHEN 计算外向性分数时 THEN 系统 SHALL 基于消息长度、感叹号使用、表情符号使用和积极情绪进行评估
5. WHEN 计算神经质分数时 THEN 系统 SHALL 基于情绪波动、负面情绪频率和焦虑相关词汇进行评估
6. WHEN 性格推断完成后 THEN 系统 SHALL 计算分析可信度，样本量越大可信度越高
7. WHEN 用户继续对话 THEN 系统 SHALL 持续更新性格维度分数

### 需求 5: AI角色系统

**用户故事**: 作为用户，我希望能够选择不同性格的AI助手与我对话，以便获得符合我当前需求的交互体验。

#### 验收标准

1. WHEN 系统初始化时 THEN 系统 SHALL 提供至少三种预设AI角色：友好助手、专业顾问和创意伙伴
2. WHEN 用户选择AI角色时 THEN 系统 SHALL 加载该角色的性格特征、对话风格和系统提示词
3. WHEN AI角色被激活 THEN 系统 SHALL 使用该角色的系统提示词初始化对话模型
4. WHEN 用户未选择角色 THEN 系统 SHALL 使用默认的友好助手角色
5. WHEN 用户切换AI角色 THEN 系统 SHALL 在新对话中应用新角色的特征

### 需求 6: 个性化提示词生成

**用户故事**: 作为系统，我需要根据用户的性格特征和沟通风格动态生成个性化的系统提示词，以便AI能够以最适合用户的方式进行回应。

#### 验收标准

1. WHEN 生成个性化提示词时 THEN 系统 SHALL 结合AI角色的基础提示词和用户的性格特征
2. WHEN 用户外向性分数高于0.7 THEN 系统 SHALL 在提示词中添加"更加热情和活跃地回应"的指令
3. WHEN 用户外向性分数低于0.3 THEN 系统 SHALL 在提示词中添加"保持温和、不过分热情"的指令
4. WHEN 用户正式程度高于0.7 THEN 系统 SHALL 在提示词中添加"使用更正式的语言"的指令
5. WHEN 用户平均消息长度超过100字符 THEN 系统 SHALL 在提示词中添加"提供更详细的回答"的指令
6. WHEN 用户情感表达丰富（分数高于0.7）THEN 系统 SHALL 在提示词中添加"使用更多表情符号和感叹词"的指令

### 需求 7: 多模型AI集成

**用户故事**: 作为系统管理员，我需要系统能够调用多种国内外大模型API，以便为用户提供多样化的AI服务选择。

#### 验收标准

1. WHEN 系统配置完成后 THEN 系统 SHALL 支持调用GPT-4、Claude-3、Gemini和豆包等多种模型
2. WHEN 调用国外模型时 THEN 系统 SHALL 通过配置的代理服务器转发请求
3. WHEN 代理服务器不可用 THEN 系统 SHALL 自动降级到国内可用模型
4. WHEN 调用模型API时 THEN 系统 SHALL 在请求中包含用户标识符用于追踪
5. WHEN API调用失败 THEN 系统 SHALL 记录错误日志并返回友好的错误提示

### 需求 8: 海外API代理服务

**用户故事**: 作为系统架构师，我需要部署一个海外代理服务器，以便国内用户能够稳定访问国外的AI模型API。

#### 验收标准

1. WHEN 部署代理服务器时 THEN 系统 SHALL 在海外VPS上运行Nginx和Node.js网关服务
2. WHEN 代理服务器接收请求时 THEN 系统 SHALL 验证请求来源是否为授权域名
3. WHEN 转发OpenAI请求时 THEN 系统 SHALL 自动添加API密钥到请求头
4. WHEN 转发Claude请求时 THEN 系统 SHALL 自动添加x-api-key到请求头
5. WHEN 转发Gemini请求时 THEN 系统 SHALL 自动添加API密钥到URL参数
6. WHEN 代理服务器处理请求时 THEN 系统 SHALL 实施速率限制，每个IP每15分钟最多100次请求
7. WHEN 代理服务器启动时 THEN 系统 SHALL 配置SSL证书以支持HTTPS访问

### 需求 9: 用户数据持久化

**用户故事**: 作为用户，我希望我的对话历史、偏好设置和性格分析结果能够被保存，以便我下次访问时能够继续获得个性化服务。

#### 验收标准

1. WHEN 用户首次创建时 THEN 系统 SHALL 在数据库中创建用户记录，包含用户ID、设备指纹、创建时间和最后活跃时间
2. WHEN 用户发送消息时 THEN 系统 SHALL 将消息内容、时间戳和提取的特征存储到数据库
3. WHEN 性格分析更新时 THEN 系统 SHALL 将五个性格维度分数、可信度和样本数量存储到数据库
4. WHEN 用户选择AI角色时 THEN 系统 SHALL 将用户的角色偏好存储到用户配置中
5. WHEN 用户数据更新时 THEN 系统 SHALL 同时更新Redis缓存以提高访问速度

### 需求 10: 管理后台用户画像展示

**用户故事**: 作为系统管理员，我需要一个可视化的管理后台来查看用户的性格分析、对话特征和使用统计，以便了解系统运行状况和用户行为模式。

#### 验收标准

1. WHEN 管理员访问用户画像页面 THEN 系统 SHALL 显示用户的基本信息、注册时间、最后活跃时间和消息总数
2. WHEN 显示性格特征时 THEN 系统 SHALL 使用雷达图展示五个性格维度的分数
3. WHEN 显示沟通风格时 THEN 系统 SHALL 使用进度条展示正式程度、情感表达和平均消息长度
4. WHEN 显示话题偏好时 THEN 系统 SHALL 使用词云图展示用户最常讨论的话题
5. WHEN 显示对话趋势时 THEN 系统 SHALL 使用折线图展示用户的活跃度和情感变化趋势
6. WHEN 性格分析样本不足时 THEN 系统 SHALL 显示"数据不足"提示和当前样本数量

### 需求 11: 管理后台用户列表和搜索

**用户故事**: 作为系统管理员，我需要能够浏览所有用户列表并搜索特定用户，以便快速定位和分析目标用户。

#### 验收标准

1. WHEN 管理员访问用户列表页面 THEN 系统 SHALL 显示所有用户的ID、创建时间、最后活跃时间、消息数量和活跃状态
2. WHEN 用户列表超过20条 THEN 系统 SHALL 实现分页功能，每页显示20条记录
3. WHEN 管理员输入搜索关键词 THEN 系统 SHALL 支持按用户ID、手机号或设备指纹进行搜索
4. WHEN 管理员点击用户记录 THEN 系统 SHALL 跳转到该用户的详细画像页面
5. WHEN 管理员筛选用户时 THEN 系统 SHALL 支持按注册时间范围、活跃状态和消息数量进行筛选

### 需求 12: 管理后台AI模型使用统计

**用户故事**: 作为系统管理员，我需要查看各个AI模型的使用情况和成本统计，以便优化资源配置和控制成本。

#### 验收标准

1. WHEN 管理员访问模型统计页面 THEN 系统 SHALL 显示每个模型的调用次数、成功率、平均响应时间和总成本
2. WHEN 显示成本统计时 THEN 系统 SHALL 基于token使用量和模型定价计算实际成本
3. WHEN 显示时间趋势时 THEN 系统 SHALL 使用折线图展示过去30天的模型使用量变化
4. WHEN 某个模型失败率超过10% THEN 系统 SHALL 在页面上显示警告提示
5. WHEN 管理员选择时间范围 THEN 系统 SHALL 支持查看自定义时间段的统计数据

### 需求 13: 隐私和数据安全

**用户故事**: 作为用户，我希望我的个人信息和对话内容得到妥善保护，系统应该遵守数据隐私法规。

#### 验收标准

1. WHEN 存储用户手机号时 THEN 系统 SHALL 使用AES-256加密算法加密后存储
2. WHEN 在日志中记录用户信息时 THEN 系统 SHALL 对手机号进行脱敏处理，仅显示前3位和后4位
3. WHEN 在管理后台显示设备指纹时 THEN 系统 SHALL 仅显示前4位和后4位
4. WHEN 用户请求删除数据时 THEN 系统 SHALL 删除该用户的所有个人信息和对话记录
5. WHEN 传输敏感数据时 THEN 系统 SHALL 使用HTTPS协议加密传输

### 需求 14: 小程序特殊支持

**用户故事**: 作为小程序用户，我希望能够使用微信授权快速绑定身份，并获得与Web端一致的个性化体验。

#### 验收标准

1. WHEN 用户在小程序中首次启动 THEN 系统 SHALL 使用wx.login获取登录凭证并生成用户标识
2. WHEN 用户授权获取手机号 THEN 系统 SHALL 将加密数据发送到后端解密并绑定用户
3. WHEN 用户授权获取用户信息 THEN 系统 SHALL 保存用户昵称和头像到用户资料
4. WHEN 小程序生成设备指纹时 THEN 系统 SHALL 使用设备品牌、型号、系统版本和屏幕信息生成指纹
5. WHEN 用户在小程序和Web端使用相同手机号 THEN 系统 SHALL 同步两端的对话历史和个性化设置

### 需求 15: 性格分析训练和优化

**用户故事**: 作为系统开发者，我需要持续优化性格分析算法，以便提高分析的准确性和可靠性。

#### 验收标准

1. WHEN 收集到足够的用户反馈数据 THEN 系统 SHALL 支持使用机器学习模型优化性格推断算法
2. WHEN 用户对AI回应进行评分 THEN 系统 SHALL 记录评分数据用于算法优化
3. WHEN 性格分析结果与用户实际行为不符 THEN 系统 SHALL 支持手动调整性格维度权重
4. WHEN 算法更新后 THEN 系统 SHALL 对历史用户数据重新进行性格分析
5. WHEN 分析可信度低于0.3 THEN 系统 SHALL 不使用性格数据进行个性化调整

### 需求 16: 系统监控和告警

**用户故事**: 作为系统运维人员，我需要实时监控系统运行状态，并在出现异常时及时收到告警通知。

#### 验收标准

1. WHEN 代理服务器响应时间超过5秒 THEN 系统 SHALL 发送告警通知
2. WHEN 任何AI模型的失败率在1小时内超过20% THEN 系统 SHALL 发送告警通知
3. WHEN 数据库连接失败 THEN 系统 SHALL 发送紧急告警通知
4. WHEN 系统每日活跃用户数异常下降超过30% THEN 系统 SHALL 发送告警通知
5. WHEN 告警触发时 THEN 系统 SHALL 通过邮件和企业微信发送通知给运维团队
